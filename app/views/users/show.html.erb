<div class='container px-5 px-sm-0'>
  <div class='row'>
    <div class='col-md-3'>
      <h2>User info</h2>
      <%= render 'info', user: @user %>
      <h2 class="mt-3">New book</h2>
      <%= render 'books/form', book: @book %>
    </div>
    <div class='col-md-8 offset-md-1'>
      <h2>Books</h2>
      <%= render 'books/index',books: @user.books %>

      <h2>投稿数の前日比・前週比</h2>
      <table class="table table-bordered text-center">
        <thead>
          <tr>
            <th>今日の投稿数</th>
            <th>昨日の投稿数</th>
            <th>前日比</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><%= @user.todays_books_count %></td>
            <td><%= @user.yesterdays_books_count %></td>
            <td><%= @user.compare_today_and_yesterday %></td>
          </tr>
        </tbody>
      </table>
      
      <table class="table table-bordered text-center mt-4">
        <thead>
          <tr>
            <th>今週の投稿数</th>
            <th>先週の投稿数</th>
            <th>前週比</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><%= @user.this_week_books_count %></td>
            <td><%= @user.last_week_books_count %></td>
            <td><%= @user.compare_this_and_last_week %></td>
          </tr>
        </tbody>
      </table>

      <h2>7日間分の投稿数</h2>
      <table class="table table-bordered text-center">
        <thead>
          <tr>
            <% (6).downto(0) do |i| %>
              <th><%= i == 0 ? "今日" : "#{i}日前" %></th>
            <% end %>
          </tr>
        </thead>
        <tbody>
          <tr>
            <% @user.last_7_days_books_counts_reverse.each do |count| %>
              <td><%= count %></td>
            <% end %>
          </tr>
        </tbody>
      </table>

      <h2>7日間の投稿数の比較</h2>
      <canvas id="booksLineChart" width="600" height="300"></canvas>

      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      <script>
        document.addEventListener("DOMContentLoaded", function() {
          var ctx = document.getElementById('booksLineChart').getContext('2d');
          var booksLineChart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: ["6日前", "5日前", "4日前", "3日前", "2日前", "1日前", "今日"],
              datasets: [{
                label: '投稿数',
                data: <%= raw @last_7_days_counts.to_json %>,
                fill: false,
                borderColor: 'rgba(54, 162, 235, 1)',
                backgroundColor: 'rgba(54, 162, 235, 0.5)',
                tension: 0.3,
                pointBackgroundColor: 'rgba(54, 162, 235, 1)',
                pointRadius: 5
              }]
            },
            options: {
              scales: {
                y: {
                  beginAtZero: true,
                  min: 0,
                  max: 10,
                  ticks: {
                    stepSize: 1,
                    precision: 0,
                    callback: function(value) { return Number.isInteger(value) ? value : null; }
                  }
                }
              }
            }
          });
        });
      </script>

      <h2>指定日の投稿数検索</h2>
      <input type="date" id="date_picker">
      <button id="fetch_count_btn">検索</button>
      
      <div id="books_count_result"></div>
      
      <script>
        document.addEventListener("DOMContentLoaded", function() {
          document.getElementById("fetch_count_btn").onclick = function() {
            var date = document.getElementById("date_picker").value;
            if (!date) return;
      
            fetch(`/users/<%= @user.id %>/books_count_on_date.json?date=${date}`)
              .then(response => {
                if(!response.ok) throw new Error("データ取得失敗");
                return response.json();
              })
              .then(data => {
                document.getElementById("books_count_result").innerHTML = `
                  <h3>検索結果</h3>
                  <table class="table table-bordered text-center" style="width: 300px;">
                    <thead>
                      <tr>
                        <th>日付</th>
                        <th>投稿数</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td>${data.date}</td>
                        <td>${data.count}</td>
                      </tr>
                    </tbody>
                  </table>
                `;
              })
              .catch(error => {
                document.getElementById("books_count_result").innerHTML =
                  "<span style='color:red'>エラー: " + error.message + "</span>";
              });
          };
        });
      </script>

    </div>
  </div>
</div>


